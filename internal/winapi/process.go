package winapi

import (
	"fmt"
	"os"
	"os/exec"
	"os/signal"
	"sync"
	"syscall"
)

// –ì–ª–æ–±–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
var (
	runningProcesses = make(map[*exec.Cmd]bool)
	processMutex     sync.Mutex
)

// TrackProcess –¥–æ–±–∞–≤–ª—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –≤ —Å–ø–∏—Å–æ–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
func TrackProcess(cmd *exec.Cmd) {
	processMutex.Lock()
	runningProcesses[cmd] = true
	processMutex.Unlock()
}

// UntrackProcess —É–¥–∞–ª—è–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –∏–∑ —Å–ø–∏—Å–∫–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
func UntrackProcess(cmd *exec.Cmd) {
	processMutex.Lock()
	delete(runningProcesses, cmd)
	processMutex.Unlock()
}

// KillAllProcesses –∑–∞–≤–µ—Ä—à–∞–µ—Ç –≤—Å–µ –∑–∞–ø—É—â–µ–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
func KillAllProcesses() {
	// –ö–æ–ø–∏—Ä—É–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –ø–æ–¥ –∑–∞—â–∏—Ç–æ–π –º—å—é—Ç–µ–∫—Å–∞
	processMutex.Lock()
	processesCopy := make([]*exec.Cmd, 0, len(runningProcesses))
	for cmd := range runningProcesses {
		processesCopy = append(processesCopy, cmd)
	}
	runningProcesses = make(map[*exec.Cmd]bool)
	processMutex.Unlock()

	// –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã –±–µ–∑ —É–¥–µ—Ä–∂–∞–Ω–∏—è –º—å—é—Ç–µ–∫—Å–∞
	for _, cmd := range processesCopy {
		if cmd.Process != nil {
			cmd.Process.Kill()
		}
	}
}

// SetupCloseHandler –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –∫–æ–Ω—Å–æ–ª–∏
func SetupCloseHandler(cleanupFunc func()) {
	c := make(chan os.Signal, 1)
	signal.Notify(c, os.Interrupt, syscall.SIGTERM)

	go func() {
		<-c
		cleanupFunc()
		os.Exit(0)
	}()
}

// Cleanup —Ñ—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
func Cleanup() {
	KillAllProcesses()

	// –ö—Ä–∞—Å–∏–≤–æ–µ ASCII-–∞—Ä—Ç –ø—Ä–æ—â–∞–Ω–∏–µ
	fmt.Println()
	fmt.Println("\033[36;1m‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\033[0m")
	fmt.Println("\033[36;1m‚ïë                                                           ‚ïë\033[0m")
	fmt.Println("\033[36;1m‚ïë\033[0m    \033[35;1m‚ñë‚ñà‚ñÄ‚ñÄ‚ñë‚ñà‚ñë‚ñà‚ñë‚ñà‚ñÄ‚ñÄ‚ñë‚ñÄ‚ñà‚ñÄ‚ñë‚ñà‚ñÄ‚ñà‚ñë‚ñà‚ñÄ‚ñÄ‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà‚ñÄ‚ñÄ‚ñë‚ñà‚ñë‚ñà‚ñë‚ñÄ‚ñà‚ñÄ‚ñë‚ñÄ‚ñà‚ñÄ\033[0m    \033[36;1m‚ïë\033[0m")
	fmt.Println("\033[36;1m‚ïë\033[0m    \033[35;1m‚ñë‚ñà‚ñë‚ñë‚ñë‚ñà‚ñë‚ñà‚ñë‚ñÄ‚ñÄ‚ñà‚ñë‚ñë‚ñà‚ñë‚ñë‚ñà‚ñë‚ñà‚ñë‚ñÄ‚ñÄ‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñà‚ñÄ‚ñÄ‚ñë‚ñÑ‚ñÄ‚ñÑ‚ñë‚ñë‚ñà‚ñë‚ñë‚ñë‚ñà‚ñë\033[0m    \033[36;1m‚ïë\033[0m")
	fmt.Println("\033[36;1m‚ïë\033[0m    \033[35;1m‚ñë‚ñÄ‚ñÄ‚ñÄ‚ñë‚ñÄ‚ñÄ‚ñÄ‚ñë‚ñÄ‚ñÄ‚ñÄ‚ñë‚ñë‚ñÄ‚ñë‚ñë‚ñÄ‚ñÄ‚ñÄ‚ñë‚ñÄ‚ñÄ‚ñÄ‚ñë‚ñÄ‚ñë‚ñë‚ñë‚ñÄ‚ñÄ‚ñÄ‚ñë‚ñÄ‚ñë‚ñÄ‚ñë‚ñÄ‚ñÄ‚ñÄ‚ñë‚ñë‚ñÄ‚ñë\033[0m    \033[36;1m‚ïë\033[0m")
	fmt.Println("\033[36;1m‚ïë                                                           ‚ïë\033[0m")
	fmt.Println("\033[36;1m‚ïë\033[0m          \033[33;1m‚ú® –°–ø–∞—Å–∏–±–æ –∑–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ! ‚ú®\033[0m              \033[36;1m‚ïë\033[0m")
	fmt.Println("\033[36;1m‚ïë                                                           ‚ïë\033[0m")
	fmt.Println("\033[36;1m‚ïë\033[0m    \033[32m‚ö° –í–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞ –Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å ‚ö°\033[0m     \033[36;1m‚ïë\033[0m")
	fmt.Println("\033[36;1m‚ïë\033[0m         \033[90müõ°Ô∏è  –ë—É–¥—å—Ç–µ –±–¥–∏—Ç–µ–ª—å–Ω—ã –∏ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã! üõ°Ô∏è\033[0m          \033[36;1m‚ïë\033[0m")
	fmt.Println("\033[36;1m‚ïë                                                           ‚ïë\033[0m")
	fmt.Println("\033[36;1m‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\033[0m")
	fmt.Println()
}
